---
- name: Gather facts
  hosts: all
  gather_facts: true
  roles:
    - role: lima_facts
      when: provider == 'lima'
    - role: ec2_facts
      when: provider == 'ec2'

- name: Set shared facts
  hosts: localhost
  gather_facts: false
  roles:
    - role: host_facts

- name: Create data directory
  hosts: all
  become: true
  tasks:
    - name: Create control-plane data directory
      file:
        path: /data/control-plane
        state: directory
        owner: '{{ ansible_env.SUDO_USER }}'

- name: Build and deploy control-plane
  hosts: "{{ hostvars['localhost'].first_manager_host }}"
  roles:
    - role: build_image
      when: external_control_plane_image is not defined
      vars:
        version: '{{ version }}'
    - role: deploy_control_plane
      vars:
        control_plane_image: "{{ external_control_plane_image | default('127.0.0.1:5000/control-plane:latest') }}"

- name: Write test configs
  hosts: localhost
  gather_facts: false
  roles:
    - role: generate_test_config
    - role: generate_bruno_config

- name: Create aliases
  hosts: all
  become: true
  roles:
    - role: etcdctl_alias
