---
# https://docs.ansible.com/ansible/latest/collections/amazon/aws/aws_caller_info_module.html
# Registers account ID In caller_info.account
- name: Get the current caller identity information
  amazon.aws.aws_caller_info:
  register: caller_info

# Get the current region using the default credential chain
- name: Get current region
  ansible.builtin.command: |
    {{ ansible_playbook_python | default(ansible_python.executable) }}
    -c "import boto3; print(boto3.session.Session().region_name or '')"
  register: boto3_region
  changed_when: false

- name: Set fact for AWS region
  ansible.builtin.set_fact:
    aws_region: "{{ boto3_region.stdout | trim }}"

# https://docs.ansible.com/ansible/latest/collections/community/general/ipify_facts_module.html
- name: Get test runner public IP
  community.general.ipify_facts:

# https://docs.ansible.com/ansible/latest/collections/amazon/aws/ec2_vpc_net_info_module.html
- name: Get default VPC for current region
  amazon.aws.ec2_vpc_net_info:
    region: '{{ aws_region }}'
    filters:
      is-default: 'true'
  register: default_vpc_info

- name: Set default VPC ID
  set_fact:
    default_vpc_id: '{{ default_vpc_info.vpcs[0].id }}'

# https://docs.ansible.com/ansible/latest/collections/amazon/aws/ec2_vpc_subnet_info_module.html
- name: Get default subnets for VPC
  amazon.aws.ec2_vpc_subnet_info:
    filters:
      vpc-id: '{{ default_vpc_info.vpcs[0].id }}'
      default-for-az: "true"
  register: default_subnet_info

- name: Set default subnet ID
  set_fact:
    default_subnet_id: '{{ default_subnet_info.subnets[0].id }}'

# https://docs.ansible.com/ansible/latest/collections/amazon/aws/ec2_ami_info_module.html
- name: Find matching AMIs
  amazon.aws.ec2_ami_info:
    region: '{{ aws_region }}'
    owners: '{{ _ami_params[instance_os].owner }}'
    filters:
      name: '{{ _ami_params[instance_os].name }}'
      architecture: '{{ architecture }}'
      virtualization-type: hvm
      root-device-type: ebs
  register: ami_info

- name: Set AMI ID
  set_fact:
    ami_id: '{{ ami_info.images[0].image_id }}'

- name: Generate deployment key
  community.crypto.openssh_keypair:
    path: outputs/ec2_deploy

- name: Submit deployment key to AWS
  amazon.aws.ec2_key:
    region: '{{ aws_region }}'
    name: control_plane_e2e
    key_material: "{{ lookup('file', 'outputs/ec2_deploy.pub') }}"
    tags:
      Environment: e2e-test
      Project: control-plane

- name: Set S3 bucket name
  set_fact:
    s3_bucket_name: control-plane-e2e-{{ caller_info.account }}-{{ aws_region }}

- name: Create S3 bucket
  amazon.aws.s3_bucket:
    region: '{{ aws_region }}'
    name: '{{ s3_bucket_name }}'
    state: present
    tags:
      Environment: e2e-test
      Project: control-plane

- name: Create EC2 instance role
  amazon.aws.iam_role:
    name: control-plane-e2e-instance-{{ aws_region }}
    assume_role_policy_document: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {
              "Service": "ec2.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
          }
        ]
      }
    description: EC2 instance for for control-plane E2E tests
    tags:
      Environment: e2e-test
      Project: control-plane

- name: Grant S3 bucket permissions to instance role
  amazon.aws.iam_policy:
    iam_type: role
    iam_name: control-plane-e2e-instance-{{ aws_region }}
    policy_name: bucket_access
    state: present
    policy_json: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": [
              "s3:DeleteObject",
              "s3:DeleteObjectTagging",
              "s3:GetObjectTagging",
              "s3:GetObject",
              "s3:ListBucket",
              "s3:PutObject",
              "s3:PutObjectTagging"
            ],
            "Resource": [
              "arn:aws:s3:::{{ s3_bucket_name }}",
              "arn:aws:s3:::{{ s3_bucket_name }}/*"
            ]
          }
        ]
      }

- name: Create EC2 instance profile
  amazon.aws.iam_instance_profile:
    name: control-plane-e2e-instance-{{ aws_region }}
    state: present
    role: control-plane-e2e-instance-{{ aws_region }}
    tags:
      Environment: e2e-test
      Project: control-plane

# https://docs.ansible.com/ansible/latest/collections/amazon/aws/ec2_security_group_module.html
- name: Create security group for EC2 instances
  amazon.aws.ec2_security_group:
    region: '{{ aws_region }}'
    name: control-plane-e2e
    description: Security group for control plane E2E instances
    vpc_id: '{{ default_vpc_id }}'
    rules:
      - proto: "-1"
        from_port: 0
        to_port: 0
        group_name: control-plane-e2e
        rule_desc: Allow all from within the security group
      - proto: "-1"
        from_port: 0
        to_port: 0
        cidr_ip: '{{ ipify_public_ip }}/32'
        rule_desc: Allow all from test runner IP
    rules_egress:
      - proto: "-1"
        from_port: 0
        to_port: 0
        cidr_ip: 0.0.0.0/0
    tags:
      Environment: e2e-test
      Project: control-plane
  register: security_group

- name: Create EC2 instances
  amazon.aws.ec2_instance:
    region: '{{ aws_region }}'
    name: control-plane-e2e-{{ architecture }}-{{ item.name }}
    state: started
    key_name: control_plane_e2e
    vpc_subnet_id: '{{ default_subnet_id }}'
    instance_type: '{{ _instance_types[architecture] }}'
    security_group: '{{ security_group.group_id }}'
    iam_instance_profile: control-plane-e2e-instance-{{ aws_region }}
    network_interfaces:
      - assign_public_ip: true
    image_id: '{{ ami_id }}'
    metadata_options:
      http_endpoint: enabled
      http_put_response_hop_limit: 2
    tags:
      Environment: e2e-test
      Project: control-plane
  with_items: '{{ machines }}'
  register: ec2

- name: Concat instances
  no_log: true
  set_fact:
    ec2_instances: "{{ ec2_instances | default([]) + item.instances }}"
  with_items: '{{ ec2.results }}'

- name: Produce items2dict input
  no_log: true
  set_fact:
    ec2_instance_kvs: "{{ ec2_instance_kvs | default([]) + [{ 'key': item.tags.Name, 'value': item }] }}"
  with_items: '{{ ec2_instances }}'

- name: Produce final dictionary of instances
  no_log: true
  set_fact:
    ec2_instances: '{{ ec2_instance_kvs | default([]) | items2dict }}'

- name: Generate inventory
  template:
    src: inventory.yaml.tmpl
    dest: outputs/ec2.inventory.yaml
