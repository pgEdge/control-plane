# Running the Control Plane locally

The `docker/control-plane-dev` directory contains configuration for a three-host
Control Plane cluster that runs in Docker via Docker Compose.

- [Running a local Control Plane cluster in Docker](#running-a-local-control-plane-cluster-in-docker)
  - [Prerequisites](#prerequisites)
    - [Docker Desktop](#docker-desktop)
      - [Configuration](#configuration)
    - [Restish](#restish)
  - [Running the Control Plane](#running-the-control-plane)
  - [Interact with the Control Plane API](#interact-with-the-control-plane-api)
  - [Resetting each Control Plane instance](#resetting-each-control-plane-instance)
  - [Development workflow](#development-workflow)
    - [Rebuilding the `control-plane` binary](#rebuilding-the-control-plane-binary)
    - [Debugging](#debugging)
  - [API documentation](#api-documentation)

## Prerequisites

### Docker Desktop

On MacOS, Docker Desktop can be obtained through the Kandji Self Service App or
from the [official download page](https://www.docker.com/products/docker-desktop/).

#### Configuration

After you've installed Docker Desktop, make sure to change the settings to
provide adequate [disk space, CPU, and RAM](https://docs.docker.com/desktop/settings-and-maintenance/settings/#resources). My current settings:

- 100% of available CPUs
- 50% of available RAM
- 60GB of disk space
  - You can use `docker system df` to monitor available space and increase this
    as needed.

> [!IMPORTANT]
> Our Docker Compose configuration uses host networking, so you must also enable
> [the host networking setting](https://docs.docker.com/engine/network/drivers/host/#docker-desktop).

### Restish

Restish is a CLI tool to interact with REST APIs that expose an OpenAPI spec,
like the Control Plane API. It's not strictly required, but it is recommended.

[Installation guide](https://rest.sh/#/guide)

```sh
brew install rest-sh/tap/restish
```

It's recommended to add this environment variable to your `.zshrc` as well to
disable Restish's default retry behavior:

```sh
export RSH_RETRY=0
```

After you've added this line, you can run `exec zsh` to reload the configuration
in your current shell session. It will automatically apply to any new sessions.

After installation, modify the Restish configuration file to add entries for the
local Control Plane instances. On MacOS, this file will be
`~/Library/Application Support/restish/apis.json`. See
[the configuration page](https://rest.sh/#/configuration) to find the
configuration file location for non-MacOS systems.

```json
{
  "$schema": "https://rest.sh/schemas/apis.json",
  "control-plane-local-1": {
    "base": "http://localhost:3000",
    "profiles": {
      "default": {
        
      }
    },
    "tls": {}
  },
  "control-plane-local-2": {
    "base": "http://localhost:3001",
    "profiles": {
      "default": {
        
      }
    },
    "tls": {}
  },
  "control-plane-local-3": {
    "base": "http://localhost:3002",
    "profiles": {
      "default": {
        
      }
    },
    "tls": {}
  }
}
```

## Running the Control Plane

In order to start the Control Plane instances, run:

```sh
make dev-watch
```

This will build a `control-plane` binary, build the Docker image in
`docker/control-plane-dev`, and run the Docker Compose configuration in "watch
mode". See the [Development workflow](#development-workflow) section to learn
how to use this setup for development.

## Interact with the Control Plane API

Now, you should be able to interact with the API using restish. For example, to
initialize a new cluster and create a new database:

```sh
restish control-plane-local-1 init-cluster
restish control-plane-local-2 join-cluster "$(restish control-plane-local-1 get-join-token)"
restish control-plane-local-3 join-cluster "$(restish control-plane-local-1 get-join-token)"
restish control-plane-local-1 create-database '{"spec":{"database_name":"my_app","database_users":[{"username":"admin","password":"password","attributes":["SUPERUSER","LOGIN"]},{"username":"app","password":"password","attributes":["LOGIN"],"roles":["pgedge_application"]}],"nodes":[{"name":"n1","host_ids":["host-1"]},{"name":"n2","host_ids":["host-2"]},{"name":"n3","host_ids":["host-3"]}]}}'
```

The API is under active development. You can find the current set of endpoints
in a variety of places:

- The autogenerated help text in `restish`: `restish control-plane-local-1 --help`
- The Go source of the API specification in `api/apiv1/design`
- The generated OpenAPI spec in `api/apiv1/gen/http/openapi.yaml`

Endpoints that are unimplemented will return a "not implemented" error.

# Resetting your dev environment

To reset your dev environment to its initial state, run:

```
make dev-teardown
```

This will:

- Shutdown the control plane
- Remove any databases and database networks
- Remove the data directories for each instance

When you start the control plane again with `make dev-watch`, it will be in an
uninitialized state. Then, you can follow the instructions in the
[Interact with the Control Plane API](#interact-with-the-control-plane-api)
section to reinitialize your cluster.

## Development workflow

### Rebuilding the `control-plane` binary

The Docker Compose file is configured to watch for changes to the
`control-plane` binary. You can update the binary in the running containers by
running:

```sh
make dev-build
```

You'll see messages in the docker compose output to indicate that it's stopping
the containers, syncing the files, and then starting them up again. This takes
about 10 seconds due to the graceful shutdown in the Control Plane server.

### Debugging

The `control-plane-dev` image includes the Delve Go debugger. You can run the
debugger by adding the `DEBUG` environment variable to the `make dev-watch`
command:

```sh
DEBUG=1 make dev-watch
```

This will run the debugger in the `host-1` Control Plane container. The debugger
will wait until you've attached to it before starting the Control Plane server.
This is an example remote debugging configuration for VSCode:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Docker debug",
      "type": "go",
      "request": "attach",
      "mode": "remote",
      "remotePath": "${workspaceFolder}",
      "port": 2345,
      "host": "localhost", 
    }
  ]
}
```

After attaching the debugger, the server will start normally.

## API documentation

The `docker-compose.yaml` file for this configuration includes an API
documentation server. You can access the documentation in your browser at
http://localhost:8999.

This uses the OpenAPI spec from the `api/apiv1/gen` directory and generates the
documentation on the client side. When you regenerate the OpenAPI spec, for
example by running `make -C api generate`, you only need to refresh the page to
see the updates.
