meta {
  name: Add nodes invalid
  type: http
  seq: 5
}

docs {
  This request should trigger several validation errors:
  
  - One new node has both a `source_node` and a `restore_config`
  - One new node's `source_node` is self-referential
  - One new node's `source_node` refers to another new node
}

post {
  url: {{host_1_url}}/v1/databases/:database_id
  body: json
  auth: none
}

params:path {
  database_id: storefront
}

body:json {
  {
    "spec": {
      "database_name": "storefront",
      "database_users": [
        {
          "username": "admin",
          "db_owner": true,
          "attributes": ["SUPERUSER", "LOGIN"]
        }
      ],
      "nodes": [
        { "name": "n1", "host_ids": ["host-1"] },
        { "name": "n2", "host_ids": ["host-2"] },
        {
          "name": "n3",
          "host_ids": ["host-3"],
          "source_node": "n1",
          "restore_config": {
            "source_database_id": "storefront",
            "source_node_name": "n1",
            "source_database_name": "storefront",
            "repository": {
              "type": "posix",
              "base_path": "/tmp"
            }
          }
        },
        { "name": "n4", "host_ids": ["host-1"], "source_node": "n4" },
        { "name": "n5", "host_ids": ["host-2"], "source_node": "n3" }
      ]
    }
  }
}

vars:pre-request {
  wait_for_task: true
}
